<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> SquareCTF 2023 enCRCroach | Gary Song </title> <meta name="author" content="Gary Song"> <meta name="description" content="Why webdevelopers should learn cryptorgraphy"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%92&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://freed2003.github.io/blog/2023/enCRCroach/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Gary</span> Song </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">SquareCTF 2023 enCRCroach</h1> <p class="post-meta"> Created in October 03, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/crypto"> <i class="fa-solid fa-hashtag fa-sm"></i> crypto</a>   ·   <a href="/blog/category/ctf-writeups"> <i class="fa-solid fa-tag fa-sm"></i> ctf-writeups</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>We’re given the source code to a server where we are supposed to impersonate admin. Validation is done by a token that is encrypted with AES-CTR. Basically, the server decrypts the token and checks the name of the user and if it’s admin then they spit out the flag. here’s the code.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">secrets</span>

<span class="kn">import</span> <span class="n">fastcrc</span>
<span class="kn">import</span> <span class="n">werkzeug.security</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_from_directory</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">SERVER_KEY</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SERVER_KEY</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
<span class="n">IV_LEN</span> <span class="o">=</span> <span class="mi">16</span>
<span class="c1"># USER_LEN = can potentially vary
</span><span class="n">NONCE_LEN</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">MAC_LEN</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">KEY_LEN</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">USER_DB</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Someone keeps hacking us and reading out the admin's /flag.txt.
</span>    <span class="c1"># Disabling this account to see if that helps.
</span>    <span class="c1"># "admin": "7a2f445babffa758471e3341a1fadce9abeff194aded071e4fd48b25add856a7",
</span>
    <span class="c1"># Other accounts. File a ticket similar to QDB-244321 to add or modify passwords.
</span>    <span class="sh">"</span><span class="s">azure</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">9631758175d2f048db1964727ad2efef4233099b97f383e4f1e121c900f3e722</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">cthon</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">980809b1482352ae59be5d3ede484c0835b46985309a04ac1bad70b22a167670</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">Response</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="sh">"</span><span class="s">text/plain</span><span class="sh">"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">"""</span><span class="s">Endpoints:
  - /auth?user=&lt;user&gt;: Auth a user with an optional password. Returns an auth token.
  - /read/&lt;path&gt;?token=&lt;token&gt;: Read out a file from a user</span><span class="sh">'</span><span class="s">s directory. Token required.
</span><span class="sh">"""</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/auth</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">auth</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Return a token once the user is successfully authenticated.
    </span><span class="sh">"""</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">USER_DB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">"</span><span class="s">Bad or missing </span><span class="sh">'</span><span class="s">user</span><span class="sh">'"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">USER_DB</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">given</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">pbkdf2_hmac</span><span class="p">(</span><span class="sh">"</span><span class="s">SHA256</span><span class="sh">"</span><span class="p">,</span> <span class="n">password</span><span class="p">.</span><span class="nf">encode</span><span class="p">(),</span> <span class="n">user</span><span class="p">.</span><span class="nf">encode</span><span class="p">(),</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">password_hash</span> <span class="o">!=</span> <span class="n">given</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">"</span><span class="s">Bad </span><span class="sh">'</span><span class="s">password</span><span class="sh">'"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

    <span class="c1"># User is authenticated! Return a super strong token.
</span>    <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="nf">encrypt_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">SERVER_KEY</span><span class="p">).</span><span class="nf">hex</span><span class="p">())</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/read</span><span class="sh">"</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/read/&lt;path&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Read a static file under the user</span><span class="sh">'</span><span class="s">s directory.

    Lists contents if no path is provided.

    Decrypts the token to auth the request and get the user</span><span class="sh">'</span><span class="s">s name.
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nf">decrypt_token</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">token</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">SERVER_KEY</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">"</span><span class="s">Bad or missing token</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

    <span class="n">user_dir</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="nf">safe_join</span><span class="p">(</span><span class="sh">"</span><span class="s">users</span><span class="sh">"</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">listing</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">user_dir</span><span class="p">))))</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="n">listing</span><span class="p">)</span>

    <span class="k">return</span> <span class="nf">send_from_directory</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">encrypt_token</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Encrypt the user string using </span><span class="sh">"</span><span class="s">authenticated encryption</span><span class="sh">"</span><span class="s">.

    JWTs and JWEs scare me. Too many CVEs! I think I can do better...

    Here</span><span class="sh">'</span><span class="s">s the token format we use to encrypt and authenticate a user</span><span class="sh">'</span><span class="s">s name.
    This is sent to/from the server in ascii-hex:
      len :  16    variable      42      8
      data:  IV ||   USER   || NONCE || MAC
                  </span><span class="sh">'</span><span class="s">------------------------</span><span class="sh">'</span><span class="s"> Encrypted
    </span><span class="sh">"""</span>
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_LEN</span>

    <span class="n">user_bytes</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">iv</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">token_bytes</span><span class="p">(</span><span class="n">IV_LEN</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">token_bytes</span><span class="p">(</span><span class="n">NONCE_LEN</span><span class="p">)</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="p">.</span><span class="nc">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="p">.</span><span class="nc">CTR</span><span class="p">(</span><span class="n">iv</span><span class="p">)).</span><span class="nf">encryptor</span><span class="p">()</span>

    <span class="n">mac</span> <span class="o">=</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">user_bytes</span> <span class="o">+</span> <span class="n">nonce</span><span class="p">)</span>

    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_bytes</span> <span class="o">+</span> <span class="n">nonce</span> <span class="o">+</span> <span class="n">mac</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">ciphertext</span>


<span class="k">def</span> <span class="nf">decrypt_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_LEN</span>

    <span class="n">iv</span><span class="p">,</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">splitup</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">IV_LEN</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iv</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ciphertext</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="p">.</span><span class="nc">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="p">.</span><span class="nc">CTR</span><span class="p">(</span><span class="n">iv</span><span class="p">)).</span><span class="nf">decryptor</span><span class="p">()</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">finalize</span><span class="p">()</span>

    <span class="n">user_bytes</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">mac</span> <span class="o">=</span> <span class="nf">splitup</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">NONCE_LEN</span> <span class="o">+</span> <span class="n">MAC_LEN</span><span class="p">),</span> <span class="o">-</span><span class="n">MAC_LEN</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_bytes</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NONCE_LEN</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAC_LEN</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">computed</span> <span class="o">=</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">user_bytes</span> <span class="o">+</span> <span class="n">nonce</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">computed</span> <span class="o">!=</span> <span class="n">mac</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">user_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="c1"># A 64-bit CRC should be pretty good. Faster than a hash, and can't be brute forced.
</span>    <span class="n">crc</span> <span class="o">=</span> <span class="n">fastcrc</span><span class="p">.</span><span class="n">crc64</span><span class="p">.</span><span class="nf">go_iso</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">MAC_LEN</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="sh">"</span><span class="s">big</span><span class="sh">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">splitup</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">):</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">data</span><span class="p">[</span><span class="n">last_index</span><span class="p">:</span><span class="n">index</span><span class="p">]</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">yield</span> <span class="n">data</span><span class="p">[</span><span class="n">last_index</span><span class="p">:]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">"</span><span class="s">0.0.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">FLASK_SERVER_PORT</span><span class="sh">"</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <p>Ok that’s a lot. The first main thing to look at is the encrypt and decrypt token functions. They do what they say, basically they encrypt a token of the user’s name and add the information needed to decrypt it (other than the key of course). They also add a mac to try to defend against attacks that modify the cipher text, but the mac is using CRC and we’ll later see that CRC doesn’t make for a good mac.</p> <p>So if you don’t know what CTR mode does, it basically encrypts some value with AES and then XORs the resulting value with your plaintext to produce the cipher text. It’s basically turning AES into a stream cipher. Here’s a picture to help better understand it</p> <p><img src="https://hackmd.io/_uploads/r1h4O1hB6.png" alt="image"></p> <p>Decryption is very similar. You take the nonce and increment it and xor the result with the ciphertext to get the plaintext, since xoring something with itself yields \(0\). If you don’t see it already, this is actually very susceptible to a known plaintext attack where if we know the plaintext then we can modify the ciphertext to decrypt whatever we want even if we don’t know the key. To see this, consider an arbitrary byte in the plaintext. It encrypts to the form</p> \[ct_i = pt_i \oplus enc_k(nonce + ctr)_i\] <p>And the decryption works as following</p> \[ct_i \oplus enc_k(nonce + ctr)_i = pt_i \oplus enc_k(nonce + ctr)_i \oplus enc_k(nonce + ctr)_i = pt_i\] <p>where \(i\) denote’s it’s index in the block. If we know the value of \(pt_i\) then we can xor the ciphertext byte with \(pt_i \oplus a\) for any value of \(a\). Decrypting this new value gives us</p> \[ct_i\oplus pt_i \oplus a \oplus enc_k(nonce + ctr)_i = pt_i pt_i \oplus a \oplus enc_k(nonce + ctr)_i \oplus enc_k(nonce + ctr)_i = a\] <p>and we have successfully modified our ciphertext to produce an arbitrary byte \(a\) upon decryption.</p> <p>Why is this useful for our challenge? Well, they disabled the ability to get a token with user “admin” but we can still get a token with the user “cthon” or “azure”. Even though the user name gets encrypted, we are given the position in the ciphertext so we can use our attack to change it to read “admin” instead. Should be simple enough.</p> <p>So now all we need is to get a token. This requires logging into the one of the enabled accounts. The information for these accounts is located in the code here</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USER_DB</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Someone keeps hacking us and reading out the admin's /flag.txt.
</span>    <span class="c1"># Disabling this account to see if that helps.
</span>    <span class="c1"># "admin": "7a2f445babffa758471e3341a1fadce9abeff194aded071e4fd48b25add856a7",
</span>
    <span class="c1"># Other accounts. File a ticket similar to QDB-244321 to add or modify passwords.
</span>    <span class="sh">"</span><span class="s">azure</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">9631758175d2f048db1964727ad2efef4233099b97f383e4f1e121c900f3e722</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">cthon</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">980809b1482352ae59be5d3ede484c0835b46985309a04ac1bad70b22a167670</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div> <p>The value for each key is the hash of the password, so we can’t actually get the password directly from here. We can see the process in the code here.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">password_hash</span> <span class="o">=</span> <span class="n">USER_DB</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">given</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">pbkdf2_hmac</span><span class="p">(</span><span class="sh">"</span><span class="s">SHA256</span><span class="sh">"</span><span class="p">,</span> <span class="n">password</span><span class="p">.</span><span class="nf">encode</span><span class="p">(),</span> <span class="n">user</span><span class="p">.</span><span class="nf">encode</span><span class="p">(),</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">password_hash</span> <span class="o">!=</span> <span class="n">given</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">"</span><span class="s">Bad </span><span class="sh">'</span><span class="s">password</span><span class="sh">'"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</code></pre></div></div> <p>So it’s hashing the password with pbkdf2_hmac sha256 with the salt of the user and 1000 rounds. Running hashcat with rockyou.txt will tell us the password is “<strong>**</strong>”, which is a funny password. I’m going to leave the exact details of running hashcat out of here since it’s not important, but basically you can give hashcat a dictionary, a target and the hashing method and it will bash it out for you.</p> <p>Ok, so now we input it into the website and get a token. We can use our known plaintext attack to retrieve a new token the decrypts to user “admin” and submit that. Except we forgot one thing, the CRC check on the ciphertext to check for modifications. The thing is, CRC isn’t really secure since it follows the following linear property.</p> \[CRC(a) \oplus CRC(b) \oplus CRC(c) = CRC(a\oplus b\oplus c)\] <p>for messages \(a,b,c\) that have equal length to eachother. (I won’t prove this here but I’m sure you can find something online). Ok, so using this we can calculate our new CRC. How exactly do we do this? So first let \(a\) be our original unmodified token. Remember that we modified it by xoring by another value, so that value can be \(b\). But wait! \(b\) was only of length \(5\) since we were just changing “cthon” to “admin” right? That’s much shorter than the length of \(a\). It is, so what we do is pad out the rest of the bytes that are unmodified with null bytes since xoring by a nullbyte gives the same value back. Finally, we set \(c\) equal to all nullbytes with equal length with \(a\) and \(b\). \(a\oplus b\oplus c\) is now equal to what we want, so we can find the new CRC.</p> <p>We submit this to the server, which gives us the flag. Here’s the solve script to get the new token</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">secrets</span>

<span class="kn">import</span> <span class="n">fastcrc</span>
<span class="kn">import</span> <span class="n">werkzeug.security</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="n">IV_LEN</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">ct</span> <span class="o">=</span> <span class="sh">"</span><span class="s">eb5ce85fc4b88e8e993170343a602e67d9b928b33d82346584ab3a504f8bf58d59687fcb46ded50c5af5fc55a7d6f5a38cfd07f0fcb040ccb2574ca59a05cc1aef938aa84ff6d0</span><span class="sh">"</span>
<span class="n">MAC_LEN</span> <span class="o">=</span> <span class="mi">8</span>
<span class="k">def</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="c1"># A 64-bit CRC should be pretty good. Faster than a hash, and can't be brute forced.
</span>    <span class="n">crc</span> <span class="o">=</span> <span class="n">fastcrc</span><span class="p">.</span><span class="n">crc64</span><span class="p">.</span><span class="nf">go_iso</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">MAC_LEN</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="sh">"</span><span class="s">big</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
<span class="n">mac</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="n">pt</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="o">-</span><span class="mi">50</span><span class="p">])</span>
<span class="n">target</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">admin</span><span class="sh">"</span>
<span class="n">k</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">cthon</span><span class="sh">"</span>
<span class="n">yea</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">yea</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">aa</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">yea</span><span class="p">)</span>

<span class="n">token</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">+</span> <span class="n">nonce</span>
<span class="n">org</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">"</span><span class="s">cthon</span><span class="sh">"</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span> <span class="o">*</span><span class="mi">42</span>
<span class="n">dd</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">aa</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span><span class="o">*</span><span class="mi">42</span>
<span class="n">mac3</span> <span class="o">=</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="nf">bytes</span><span class="p">(</span><span class="mi">63</span><span class="p">))</span>
<span class="n">mac2</span> <span class="o">=</span> <span class="nf">gen_mac</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
<span class="n">newmac</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">([</span><span class="n">i</span> <span class="o">^</span> <span class="n">j</span> <span class="o">^</span> <span class="n">k</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span><span class="n">mac2</span><span class="p">,</span><span class="n">mac3</span><span class="p">)])</span>

<span class="n">final</span> <span class="o">=</span> <span class="n">token</span> <span class="o">+</span> <span class="n">newmac</span>
<span class="nf">print</span><span class="p">(</span><span class="n">final</span><span class="p">.</span><span class="nf">hex</span><span class="p">())</span>
</code></pre></div></div> <p>where the initial variable \(ct\) is the token we are modifying.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/dualsummoners/">SECCON Quals 2024 Dual Summoners</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/quadprime/">Buckeye 2023 Quadprime Prime</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/twinprime/">Buckeye 2023 Twin Prime</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Gary Song. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"publications",description:"publications by categories in reversed chronological order. generated by jekyll-scholar.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects",title:"projects",description:"Some things I've worked on",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-cv",title:"cv",description:"My CV last updated November 24th, 2024",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"post-seccon-quals-2024-dual-summoners",title:"SECCON Quals 2024 Dual Summoners",description:"Nonce means only used once",section:"Posts",handler:()=>{window.location.href="/blog/2024/dualsummoners/"}},{id:"post-buckeye-2023-quadprime-prime",title:"Buckeye 2023 Quadprime Prime",description:"Quadprimes, more secure than twinprimes",section:"Posts",handler:()=>{window.location.href="/blog/2024/quadprime/"}},{id:"post-squarectf-2023-encrcroach",title:"SquareCTF 2023 enCRCroach",description:"Why webdevelopers should learn cryptorgraphy",section:"Posts",handler:()=>{window.location.href="/blog/2023/enCRCroach/"}},{id:"post-buckeye-2023-twin-prime",title:"Buckeye 2023 Twin Prime",description:"You know what's not one of a kind? A twin!",section:"Posts",handler:()=>{window.location.href="/blog/2023/twinprime/"}},{id:"news-a-simple-inline-announcement",title:"A simple inline announcement.",description:"",section:"News"},{id:"news-a-long-announcement-with-details",title:"A long announcement with details",description:"",section:"News",handler:()=>{window.location.href="/news/announcement_2/"}},{id:"news-a-simple-inline-announcement-with-markdown-emoji-sparkles-smile",title:'A simple inline announcement with Markdown emoji! <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"> <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">',description:"",section:"News"},{id:"projects-stls",title:"sTLS",description:"A toy TLS implementation\ud83c\udf89",section:"Projects",handler:()=>{window.location.href="/projects/sTLS/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%67%61%72%79.%73%6F%6E%67%32%30%30%33@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=eg77CLEAAAAJ","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/freed2003","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/g-song","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>